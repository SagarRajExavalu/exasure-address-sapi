<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	
	<sub-flow name="getAddressSubFlow" doc:id="d3217895-a573-4ad0-bfc4-8ca676bd6877" >
		<logger level="INFO" doc:name="Logger" doc:id="c1cf0a64-41fa-4528-8da5-15f1353c3f24" message="getAddressSubFlow started"/>
		<ee:transform doc:name="sqlStatement" doc:id="897717b9-4def-4047-8da4-d89f081fa8e7" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    sqlStatement: 
        if ( vars.mailable != null and vars.mailable == "true") 
            "SELECT * FROM `address-autocomplete` WHERE formattedAddress LIKE '%" ++ vars.searchText ++ "%' AND countryCode = '" ++ (vars.countryCode  default "US") ++ "' AND mailable = 1 LIMIT " ++ (vars.limit default "20")
        else 
            "SELECT * FROM `address-autocomplete` WHERE formattedAddress LIKE '%" ++ vars.searchText ++ "%' AND countryCode = '" ++ (vars.countryCode default "US") ++ "' LIMIT " ++ (vars.limit default "20")
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:select doc:name="Select" doc:id="be280aec-6316-44c4-8463-c5230a4ce291" config-ref="Database_Config">
			<error-mapping targetType="APP:DATABASE" />
			<reconnect frequency="${reconnection.frequecy}" count="${reconnection.attempts}"/>
			<db:sql ><![CDATA[#[payload.sqlStatement]]]></db:sql>
		</db:select>
		<ee:transform doc:name="Transform Message" doc:id="314dfc80-30d6-4ec9-b958-85740900392c" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload map ((item, index) ->{
    ("addressLabel":item.addressLabel) if(item.addressLabel != null),
    ("streetNumber":item.streetNumber) if(item.streetNumber != null),
    "streetName":item.streetName,
    "city":item.city,
    "stateCode":item.stateCode,
    "postalCode":item.postalCode,
    ("county":item.county)if(item.county != null),
    "countryCode":item.countryCode,
    "formattedAddress":item.formattedAddress,
    "state":item.state,
    "country":item.country,
    ("countryFlag":item.countryFlag)if(item.countryFlag != null)




} )]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="e2154f9e-6197-4c00-83ff-adebf7ee3c63" message="getAddressSubFlow ended"/>
	</sub-flow>
</mule>
